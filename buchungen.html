<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Sick & Sound – Buchungen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0e14" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
  <style>
    .content{ padding-bottom: 84px; }
    .table td,.table th{ padding:10px 8px; }
    .right{ text-align:right }
    .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .totals{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px }
    .pill{ padding:6px 10px; border-radius:999px; background:#1c2130; border:1px solid #2a3042; }
    .danger-link{ color:#ffb4b4; cursor:pointer }
    .subtle{ opacity:.8 }
    .delete-hint{ font-size:12px; opacity:.75; margin-top:4px }
  </style>
</head>
<body>
<div class="app">
  <header class="appbar">
    <div class="app-title"><div class="brand-dot"></div><h1>Buchungen</h1></div>
    <div class="appbar-actions">
      <span class="sub"><span class="statusdot" id="dot"></span><span id="connTxt">Verbinde…</span></span>
    </div>
  </header>

  <main class="content">
    <div class="card">
      <div class="section-title">Abrechnungen</div>
      <div class="controls" style="margin-top:6px">
        <select id="rangeSel" class="input" onchange="render()">
          <option value="all">Alle</option>
          <option value="month">Dieser Monat</option>
          <option value="last30">Letzte 30 Tage</option>
          <option value="year">Dieses Jahr</option>
        </select>
        <button class="btn" onclick="exportCSV()">📤 CSV exportieren</button>
        <button class="btn danger" onclick="toggleDeleteMode()" id="delBtn">🗑 Löschen</button>
        <button class="btn dark" onclick="clearAll()" id="clearBtn">♻ Alle Buchungen leeren</button>
      </div>
      <div id="delHint" class="delete-hint" style="display:none">Löschmodus aktiv: Tippe eine Zeile an, um sie zu löschen.</div>
      <div class="totals">
        <span class="pill">Gesamt: <b id="sumAll">0,00 €</b></span>
        <span class="pill">Einträge: <b id="countAll">0</b></span>
      </div>
    </div>

    <div class="card table-wrap" id="listWrap">
      <div class="sub">Lade Buchungen…</div>
    </div>

    <div class="card" id="perPersonCard" style="display:none">
      <div class="section-title">Summen pro Person</div>
      <div id="perPerson" class="subtle">–</div>
    </div>
  </main>

  <nav class="bottomnav">
    <a class="tab" href="index.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4zM4 11h16v2H4zM4 16h10v2H4z"/></svg>
      <span>Liste</span>
    </a>
    <a class="tab" href="hausdienst.html#plan">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 7-1.2 1.6L18 10.1V20h-5v-6H11v6H6v-9.9L4.2 11.6 3 10z"/></svg>
      <span>Hausdienst</span>
    </a>
    <a class="tab" href="rangliste.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 17H3V7h4v10zm7 0h-4V3h4v14zm7 0h-4v-8h4v8z"/></svg>
      <span>Rang</span>
    </a>
    <a class="tab" href="badges.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1l3.09 6.26L22 8.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 13.14 2 8.27l6.91-1.01L12 1z"/></svg>
      <span>Badges</span>
    </a>
    <a class="tab active" href="buchungen.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm8 1.5V8h4.5L14 3.5z"/></svg>
      <span>Buchungen</span>
    </a>
  </nav>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBtZsr4QPHQbvO2qae6MoBoxJF5dNP2vh0",
    authDomain: "sickandsound-8a15f.firebaseapp.com",
    projectId: "sickandsound-8a15f",
    storageBucket: "sickandsound-8a15f.appspot.com",
    messagingSenderId: "32138160959",
    appId: "1:32138160959:web:a65c7f4ad7d44e757fc18a"
  };
  const STATE_COLLECTION = location.search.includes("beta") ? "state_beta" : "state";

  let db=null, bookings=[], prices={}, people=[], deleteMode=false;

  function euro(n){ return (Number(n)||0).toFixed(2).replace('.',',')+' €'; }
  function parseDE(dstr){ // z.B. 03.09.2025 -> Date
    const m=/^(\d{1,2})\.(\d{1,2})\.(\d{2,4})$/.exec(dstr);
    if(!m) return null;
    const dd=+m[1], mm=(+m[2])-1, yy=(+m[3]<100?2000+ +m[3]:+m[3]);
    return new Date(yy,mm,dd);
  }

  function withinRange(b){
    const v=document.getElementById('rangeSel').value;
    if(v==='all') return true;
    const now=new Date();
    const d=parseDE(b.date) || new Date(b.date || 0);
    if(v==='last30'){ const from=new Date(now); from.setDate(now.getDate()-30); return d>=from && d<=now; }
    if(v==='month'){ return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear(); }
    if(v==='year'){ return d.getFullYear()===now.getFullYear(); }
    return true;
  }

  function render(){
    const wrap=document.getElementById('listWrap');
    const rows=(bookings||[])
      .filter(withinRange)
      .slice()
      .sort((a,b)=> (parseDE(b.date)-parseDE(a.date)) || a.person.localeCompare(b.person))
      .map((b,i)=>`
        <tr onclick="rowClick(${i})" title="${deleteMode?'Zum Löschen tippen':''}">
          <td>${b.date||''}</td>
          <td>${b.person||''}</td>
          <td class="right">${(b.sum!=null? euro(b.sum):'')}</td>
        </tr>
      `).join('');

    const cnt = (bookings||[]).filter(withinRange).length;
    const sum = (bookings||[]).filter(withinRange).reduce((s,b)=>s+(Number(b.sum)||0),0);

    document.getElementById('sumAll').textContent = euro(sum).replace(' €',' €');
    document.getElementById('countAll').textContent = String(cnt);

    wrap.innerHTML = `
      <table class="table">
        <thead><tr><th>Datum</th><th>Person</th><th class="right">Betrag</th></tr></thead>
        <tbody>${rows || '<tr><td colspan="3" class="sub">Keine Einträge</td></tr>'}</tbody>
      </table>
    `;

    // Summen pro Person
    const map={};
    (bookings||[]).filter(withinRange).forEach(b=>{
      map[b.person] = (map[b.person]||0) + (Number(b.sum)||0);
    });
    const ppl=Object.keys(map).sort((a,b)=>map[b]-map[a]);
    const per = ppl.map(p=> `<span class="pill">${p}: <b>${euro(map[p])}</b></span>`).join(' ');
    const card=document.getElementById('perPersonCard');
    if(ppl.length){ card.style.display='block'; document.getElementById('perPerson').innerHTML=per; }
    else{ card.style.display='none'; }
  }

  function rowClick(i){
    if(!deleteMode) return;
    const visible = bookings.filter(withinRange).slice().sort((a,b)=> (parseDE(b.date)-parseDE(a.date)) || a.person.localeCompare(b.person));
    const row = visible[i]; if(!row) return;
    if(!confirm(`Eintrag löschen?\n${row.date} – ${row.person} – ${euro(row.sum)}`)) return;
    // Finde Index im Original-Array (match by all fields & first occurrence)
    const idx = bookings.findIndex(b => b.date===row.date && b.person===row.person && Number(b.sum)===Number(row.sum));
    if(idx>-1){
      bookings.splice(idx,1);
      persist();
    }
  }

  function toggleDeleteMode(){
    deleteMode = !deleteMode;
    const btn=document.getElementById('delBtn');
    btn.textContent = deleteMode ? '❌ Abbrechen' : '🗑 Löschen';
    document.getElementById('delHint').style.display = deleteMode ? 'block' : 'none';
    render();
  }

  function clearAll(){
    const pw=prompt("Passwort eingeben:"); if(pw!=="1379"){ alert("Falsches Passwort"); return; }
    if(!confirm("Wirklich alle Buchungen dauerhaft löschen?")) return;
    bookings = [];
    persist();
  }

  function exportCSV(){
    const header=['Datum','Person','Betrag'];
    const lines = [header.join(';')];
    (bookings||[]).filter(withinRange).forEach(b=>{
      const row=[b.date||'', (b.person||'').replaceAll(';',','), (Number(b.sum)||0).toString().replace('.',',')];
      lines.push(row.join(';'));
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='buchungen.csv'; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  function persist(){
    // Schreibe zurück in Firestore
    if(!db) return render();
    db.collection(STATE_COLLECTION).doc('global').set({ bookings }, {merge:true})
      .then(()=> render())
      .catch(()=> render());
  }

  // --- Init ---
  (function init(){
    try{
      firebase.initializeApp(firebaseConfig);
      db=firebase.firestore();
      try{ db.settings({ experimentalAutoDetectLongPolling:true, merge:true }); }catch(_){}
      document.getElementById('dot').classList.add('statusok');
      document.getElementById('connTxt').textContent='Online (Firestore verbunden)';
    }catch(e){
      document.getElementById('connTxt').textContent='Offline – Firebase konnte nicht initialisiert werden.';
      db=null;
    }

    if(db){
      db.collection(STATE_COLLECTION).doc('global').onSnapshot(snap=>{
        const s=(snap.exists ? snap.data() : {}) || {};
        bookings = Array.isArray(s.bookings)? s.bookings : [];
        prices   = s.prices || {};
        people   = s.people || [];
        render();
      });
    }else{
      // reine Offline-Ansicht (falls mal nötig)
      bookings = JSON.parse(localStorage.getItem('sick_sound_bookings')||'[]');
      render();
    }
  })();
</script>

<!-- Service Worker -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js?v=21', { scope: './' }).catch(()=>{});
  }
</script>
</body>
</html>
