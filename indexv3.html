<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Sick & Sound ‚Äî Strichliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0e14" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --ring: 48px; --row-pad: 6px; --name-size: 18px; --count-size: 17px; --cell-gap: 10px;
      --sticky-top: 56px; /* H√∂he Appbar ca. */
    }
    .content{ padding-bottom: 88px; }
    .appbar{ min-height: 52px; }
    .bottomnav{ height: 64px; }
    .card.table-wrap table td, .card.table-wrap table th{ padding-top: var(--row-pad); padding-bottom: var(--row-pad); }
    .lvl-ring{ width: var(--ring); height: var(--ring); position:relative; display:inline-grid; place-items:center; }
    .lvl-ring .val{ position:absolute; font-size: 12px; font-weight: 800; line-height:1; }
    .person-cell{ display:flex; align-items:center; gap:10px; cursor:default; }
    .p-name{ font-size: var(--name-size); font-weight: 800; letter-spacing:.2px; }
    .drink-chip .drink-name{ font-size: 12px; }
    .drink-chip .drink-price{ font-size: 11px; opacity:.8 }
    .cell{ display:flex; align-items:center; justify-content:flex-end; gap: var(--cell-gap); }
    .count{ font-size: var(--count-size); min-width: 26px; text-align:right; }
    .plus-btn{ padding:8px 12px; }
    .section-row td{ font-size:12px; opacity:.7 }
    .section-title{ font-size: 14px; }

    /* CTA Checkliste */
    .cta-wrap{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:8px; }
    .cta-check{ display:inline-flex; align-items:center; gap:10px; padding:12px 16px; border-radius:14px;
      background: linear-gradient(135deg,#6ee7ff,#a78bfa); color:#0b0e14; font-weight:900; letter-spacing:.2px;
      text-decoration:none; border:none; box-shadow:0 8px 24px rgba(0,0,0,.25); cursor:pointer;
    }
    .cta-check svg{ width:20px; height:20px; }
    .cta-sub{ font-size:12px; opacity:.85; }

    /* Sticky Header */
    .card.table-wrap thead th{
      position: sticky;
      top: var(--sticky-top);
      z-index: 2;
      background: #111827; /* dunkler Hintergrund f√ºr Lesbarkeit */
      box-shadow: 0 2px 0 rgba(0,0,0,.25);
    }

    /* Hinweis im L√∂schmodus */
    .delete-hint{ opacity:.75; font-size:12px; margin-top:4px }
    .delete-mode .person-cell{ cursor:pointer }

    /* Admin styles */
    .admin-section{ margin:10px 0; padding:10px; background:#1a1f2e; border-radius:8px; border:1px solid #333; }
    .admin-section h3{ margin:0 0 10px 0; font-size:14px; color:#ff6b6b; }
    .admin-row{ display:flex; gap:8px; margin:5px 0; flex-wrap:wrap; }
    .admin-row input, .admin-row select{ flex:1; min-width:120px; }
  </style>
</head>
<body>
<div class="app">

  <!-- AppBar -->
  <header class="appbar">
    <div class="app-title">
      <div class="brand-dot"></div>
      <h1>Sick &amp; Sound</h1>
    </div>
    <div class="appbar-actions">
      <button class="btn small dark" onclick="togglePayPal()" title="PayPal">üí∏</button>
      <button class="btn small" onclick="openDrinkModal()" title="Getr√§nk hinzuf√ºgen">‚ûï</button>
      <button class="btn small" onclick="openPersonModal()" title="Person hinzuf√ºgen">üë§+</button>
      <button class="btn small danger" id="adminToggle" onclick="toggleAdminMode()" style="display:none" title="Admin Panel">Admin</button>
    </div>
  </header>

  <!-- Content -->
  <main class="content">
    <div class="card" style="margin-bottom:8px">
      <div class="section-title">Heute</div>
      <div id="todayInfo" class="sub">Lade Tagesstatus‚Ä¶</div>
      <div class="cta-wrap" id="todayCta"></div>
      <div id="delInfo" class="delete-hint" style="display:none">L√∂schmodus aktiv: Tippe auf <b>Person</b> zum L√∂schen ¬∑ Tippe auf <b>Spaltenkopf</b> zum Getr√§nk l√∂schen.</div>
    </div>

    <div class="card table-wrap" id="tableContainer"></div>

    <div class="card" style="margin-top:8px">
      <div class="section-title">Aktionen</div>
      <div class="footer" style="gap:8px;flex-wrap:wrap">
        <button class="btn warning" id="undoBtn" onclick="undoLast()">‚Ü© R√ºckg√§ngig</button>
        <button class="btn secondary" id="redoBtn" onclick="redoLast()">‚Ü™ Wiederholen</button>
        <button class="btn danger" id="deleteBtn" onclick="toggleDeleteMode()">üóë L√∂schen</button>
        <button class="btn" onclick="openPersonModal()">üë§ Person hinzuf√ºgen</button>
        <button class="btn dark" onclick="resetAll()">‚ôª Abrechnen & zur√ºcksetzen</button>
        <button class="btn ghost" onclick="window.location='buchungen.html'">üìñ Buchungen</button>
      </div>
    </div>
  </main>

  <!-- BottomNav -->
  <nav class="bottomnav">
    <a class="tab active" href="index.html" aria-label="Strichliste">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4zM4 11h16v2H4zM4 16h10v2H4z"/></svg>
      <span>Liste</span>
    </a>
    <a class="tab" href="hausdienst.html#plan" aria-label="Hausdienst">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 7-1.2 1.6L18 10.1V20h-5v-6H11v6H6v-9.9L4.2 11.6 3 10z"/></svg>
      <span>Hausdienst</span>
    </a>
    <a class="tab" href="rangliste.html" aria-label="Ranglisten">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 17H3V7h4v10zm7 0h-4V3h4v14zm7 0h-4v-8h4v8z"/></svg>
      <span>Rang</span>
    </a>
    <a class="tab" href="badges.html" aria-label="Badges">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1l3.09 6.26L22 8.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 13.14 2 8.27l6.91-1.01L12 1z"/></svg>
      <span>Badges</span>
    </a>
    <a class="tab" href="buchungen.html" aria-label="Buchungen">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm8 1.5V8h4.5L14 3.5z"/></svg>
      <span>Buchungen</span>
    </a>
  </nav>
</div>

<!-- Modals -->
<div class="modal" id="paypalModal" onclick="togglePayPal()"><img class="qr" src="frame.png" alt="PayPal QR"></div>

<div class="modal" id="personModal"><div class="box">
  <h2>‚ûï Person hinzuf√ºgen</h2>
  <input id="personName" placeholder="Name eintippen" />
  <div style="display:flex;gap:10px;margin-top:10px">
    <button class="btn" onclick="confirmAddPerson()">Speichern</button>
    <button class="btn dark" onclick="closeModal('personModal')">Abbrechen</button>
  </div>
</div></div>

<div class="modal" id="drinkModal"><div class="box">
  <h2>ü•§ Getr√§nk hinzuf√ºgen</h2>
  <input id="drinkName" placeholder="Name des Getr√§nks">
  <input id="drinkPrice" type="number" step="0.1" placeholder="Preis (‚Ç¨)">
  <div style="display:flex;gap:10px;margin-top:10px">
    <button class="btn" onclick="confirmAddDrink()">Speichern</button>
    <button class="btn dark" onclick="closeModal('drinkModal')">Abbrechen</button>
  </div>
</div></div>

<!-- Admin Modal -->
<div class="modal" id="adminModal"><div class="box">
  <h2>üîí Admin Panel</h2>
  
  <!-- Login Section -->
  <div id="adminLogin">
    <input type="password" id="adminPassword" placeholder="Admin-Passwort">
    <button class="btn" onclick="adminLogin()" style="margin-top:10px;">Einloggen</button>
    <div id="adminError" style="color:#ff4d4f;font-size:12px;margin-top:5px;display:none;"></div>
  </div>
  
  <!-- Admin Controls (hidden initially) -->
  <div id="adminControls" style="display:none;">
    <div class="admin-section">
      <h3>üìâ Striche abziehen</h3>
      <div class="admin-row">
        <select id="adminPerson" style="flex:1;">
          <option value="">Person w√§hlen...</option>
        </select>
        <select id="adminDrink" style="flex:1;">
          <option value="">Getr√§nk w√§hlen...</option>
        </select>
      </div>
      <div class="admin-row">
        <input type="number" id="adminAmount" placeholder="Anzahl abziehen" min="1" max="50" style="flex:1;">
        <button class="btn small danger" onclick="adminSubtract()">Abziehen</button>
      </div>
      <div style="font-size:12px;opacity:0.7;">Anzahl der Striche, die entfernt werden sollen</div>
    </div>
    
    <div class="admin-section">
      <h3>üíæ Backup erstellen</h3>
      <div class="admin-row">
        <button class="btn small secondary" onclick="createBackup()">üìÅ Backup herunterladen</button>
        <button class="btn small" onclick="document.getElementById('backupFile').click()">üìÇ Backup laden</button>
      </div>
      <input type="file" id="backupFile" accept=".json" style="display:none" onchange="restoreBackup()">
      <div style="font-size:12px;opacity:0.7;">Alle Daten sichern und wiederherstellen</div>
    </div>
    
    <div style="display:flex;gap:8px;margin-top:15px;">
      <button class="btn dark" onclick="closeModal('adminModal');adminLogout();">Schlie√üen</button>
    </div>
  </div>
</div></div>

<!-- Firebase + Howler -->
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.core.min.js"></script>

<script>
/* ===== Config ===== */
const CORE = ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];

// Firebase sickandsound-8a15f
const firebaseConfig = {
  apiKey: "AIzaSyBtZsr4QPHQbvO2qae6MoBoxJF5dNP2vh0",
  authDomain: "sickandsound-8a15f.firebaseapp.com",
  projectId: "sickandsound-8a15f",
  storageBucket: "sickandsound-8a15f.appspot.com",
  messagingSenderId: "32138160959",
  appId: "1:32138160959:web:a65c7f4ad7d44e757fc18a"
};

let db = null;
try{
  if(window.firebase){
    firebase.initializeApp(firebaseConfig);
    try{ firebase.analytics(); }catch(_){}
    db = firebase.firestore();
    try { db.settings({ experimentalAutoDetectLongPolling:true, merge:true }); } catch(_) {}
  }
}catch(_){ db = null; }

/* Prod/Beta Toggle */
const STATE_COLLECTION = location.search.includes("beta") ? "state_beta" : "state";

/* ===== Keys & State ===== */
const pricesKey="sick_sound_prices", peopleKey="sick_sound_people", dataKey="sick_sound_data",
      historyKey="sick_sound_history", bookingsKey="sick_sound_bookings", orderKey="sick_sound_order",
      xpKey="sick_sound_xp", redoKey="sick_sound_redo";
let prices={"Getr√§nk":1.5,"Mittagessen":6.0};
let people=[], data={}, history=[], redoStack=[], bookings=[], columnOrder=Object.keys(prices), xp={};
let deleteMode=false, hdToday=null;

/* ===== Admin System ===== */
const ADMIN_PASSWORD = "admin1379"; // Change this to your preferred password
let isAdminMode = false;
let adminLoggedIn = false;

/* ===== Sounds ===== */
const makeSound = (src)=> (window.Howl ? new Howl({src:[src]}) : {play:()=>{}});
const sClick = makeSound("https://cdn.jsdelivr.net/gh/jshawl/howler-examples@master/audio/sfx/coin1.wav");
const sLevel = makeSound("https://cdn.jsdelivr.net/gh/jshawl/howler-examples@master/audio/sfx/powerUp5.wav");

/* ===== Helpers / XP ===== */
const todayStr=()=>new Date().toISOString().slice(0,10);
const levelOf=x=>Math.floor(Math.sqrt(x/75))+1;
function valueOfCurrentStriche(person){
  return (columnOrder||[]).reduce((sum,d)=> sum + ((data[`${person}_${d}`]||0)*(prices[d]||0)), 0);
}
function getXpForDisplay(person){
  const base=+(xp[person]||0);
  const cur=valueOfCurrentStriche(person);
  return Math.max(base, cur);
}

/* Long-press +1 */
let holdT=null, holdI=null;
function startHold(handler){ stopHold(); handler(); holdT=setTimeout(()=>{holdI=setInterval(handler,120)},420); }
function stopHold(){ if(holdT) clearTimeout(holdT); if(holdI) clearInterval(holdI); holdT=holdI=null; }
window.onmouseup=stopHold; window.onmouseleave=stopHold;

/* 00:00 Refresh */
function scheduleMidnightRefresh(cb){
  const now=new Date(); const mid=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,0,2);
  setTimeout(()=>{ try{ cb(); } finally{ scheduleMidnightRefresh(cb);} }, mid-now);
}
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ updateTodayBanner(); buildTable(); } });

/* ===== Admin Functions ===== */
// Show admin button when holding brand dot for 3 seconds
let holdTimer = null;
document.addEventListener('DOMContentLoaded', () => {
  const brandDot = document.querySelector('.brand-dot');
  if (brandDot) {
    brandDot.addEventListener('mousedown', startAdminHold);
    brandDot.addEventListener('mouseup', stopAdminHold);
    brandDot.addEventListener('mouseleave', stopAdminHold);
    brandDot.addEventListener('touchstart', startAdminHold);
    brandDot.addEventListener('touchend', stopAdminHold);
  }
});

function startAdminHold() {
  holdTimer = setTimeout(() => {
    document.getElementById('adminToggle').style.display = 'block';
    if (navigator.vibrate) navigator.vibrate(50); // Haptic feedback if available
  }, 3000);
}

function stopAdminHold() {
  if (holdTimer) {
    clearTimeout(holdTimer);
    holdTimer = null;
  }
}

function toggleAdminMode() {
  if (!adminLoggedIn) {
    document.getElementById('adminModal').classList.add('show');
    populateAdminDropdowns();
  } else {
    adminLogout();
  }
}

function populateAdminDropdowns() {
  // Populate person dropdown
  const personSelect = document.getElementById('adminPerson');
  personSelect.innerHTML = '<option value="">Person w√§hlen...</option>';
  people.forEach(person => {
    personSelect.innerHTML += `<option value="${person}">${person}</option>`;
  });
  
  // Populate drink dropdown
  const drinkSelect = document.getElementById('adminDrink');
  drinkSelect.innerHTML = '<option value="">Getr√§nk w√§hlen...</option>';
  Object.keys(prices).forEach(drink => {
    drinkSelect.innerHTML += `<option value="${drink}">${drink}</option>`;
  });
}

function adminLogin() {
  const password = document.getElementById('adminPassword').value;
  const errorEl = document.getElementById('adminError');
  
  if (password === ADMIN_PASSWORD) {
    adminLoggedIn = true;
    isAdminMode = true;
    document.getElementById('adminLogin').style.display = 'none';
    document.getElementById('adminControls').style.display = 'block';
    document.getElementById('adminToggle').textContent = 'Admin ‚úì';
    document.getElementById('adminToggle').classList.add('secondary');
    errorEl.style.display = 'none';
    
    // Add visual indicator to app
    document.body.style.borderTop = '3px solid #ff6b6b';
    
    history.push({type: "admin", action: "login", timestamp: Date.now()});
  } else {
    errorEl.textContent = 'Falsches Passwort!';
    errorEl.style.display = 'block';
  }
}

function adminLogout() {
  adminLoggedIn = false;
  isAdminMode = false;
  document.getElementById('adminLogin').style.display = 'block';
  document.getElementById('adminControls').style.display = 'none';
  document.getElementById('adminToggle').textContent = 'Admin';
  document.getElementById('adminToggle').classList.remove('secondary');
  document.getElementById('adminPassword').value = '';
  document.body.style.borderTop = 'none';
  
  history.push({type: "admin", action: "logout", timestamp: Date.now()});
}

function adminSubtract() {
  const person = document.getElementById('adminPerson').value;
  const drink = document.getElementById('adminDrink').value;
  const amount = parseInt(document.getElementById('adminAmount').value) || 0;
  
  if (!person || !drink || amount <= 0) {
    alert('Bitte alle Felder ausf√ºllen und positive Anzahl eingeben');
    return;
  }
  
  const id = `${person}_${drink}`;
  const currentValue = data[id] || 0;
  const newValue = Math.max(0, currentValue - amount);
  const actualReduction = currentValue - newValue;
  
  if (actualReduction === 0) {
    alert(`${person} hat keine ${drink}-Striche zum Abziehen`);
    return;
  }
  
  // Update data
  const previousValue = data[id];
  data[id] = newValue;
  
  // Update XP (subtract the equivalent value)
  const xpReduction = actualReduction * (prices[drink] || 0);
  xp[person] = Math.max(0, (xp[person] || 0) - xpReduction);
  
  // Add to history for undo functionality
  history.push({
    type: "admin_subtract",
    id: id,
    person: person,
    drink: drink,
    prev: previousValue,
    new: newValue,
    amount: actualReduction,
    xpChange: -xpReduction,
    timestamp: Date.now()
  });
  
  // Clear redo stack since we made a new change
  redoStack = [];
  
  // Update display
  const el = document.getElementById(id);
  if (el) {
    el.textContent = newValue;
    el.classList.add('bump');
    setTimeout(() => el.classList.remove('bump'), 160);
  }
  
  updateTotalsFor(person);
  saveAll();
  updateUndoRedoButtons();
  
  // Clear form
  document.getElementById('adminAmount').value = '';
  
  alert(`${person}: ${actualReduction} ${drink}-Striche abgezogen (${currentValue} ‚Üí ${newValue})\nXP reduziert um ${xpReduction.toFixed(2)}‚Ç¨`);
}

/* ===== Backup Functions ===== */
function createBackup() {
  const backup = {
    timestamp: new Date().toISOString(),
    version: "1.0",
    data: {
      prices: prices,
      people: people,
      data: data,
      xp: xp,
      history: history,
      bookings: bookings,
      columnOrder: columnOrder
    }
  };
  
  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `sick-sound-backup-${new Date().toISOString().slice(0, 10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  alert("Backup wurde erstellt und heruntergeladen!");
}

function restoreBackup() {
  const file = document.getElementById('backupFile').files[0];
  if (!file) return;
  
  if (!confirm("Achtung: Dies √ºberschreibt alle aktuellen Daten! Fortfahren?")) {
    document.getElementById('backupFile').value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const backup = JSON.parse(e.target.result);
      
      if (!backup.data) {
        throw new Error("Ung√ºltiges Backup-Format");
      }
      
      // Restore data
      prices = backup.data.prices || prices;
      people = backup.data.people || people;
      data = backup.data.data || {};
      xp = backup.data.xp || {};
      history = backup.data.history || [];
      bookings = backup.data.bookings || [];
      columnOrder = backup.data.columnOrder || Object.keys(prices);
      
      saveAll();
      buildTable();
      updateTodayBanner();
      populateAdminDropdowns();
      
      alert(`Backup erfolgreich wiederhergestellt!\nDatum: ${backup.timestamp}`);
    } catch (error) {
      alert("Fehler beim Wiederherstellen: " + error.message);
    }
    
    document.getElementById('backupFile').value = '';
  };
  reader.readAsText(file);
}

/* ===== Load ===== */
async function loadState(){
  if(db){
    try{
      const snap=await db.collection(STATE_COLLECTION).doc("global").get();
      if(snap.exists){
        const s=snap.data();
        prices=s.prices||prices; people=s.people||JSON.parse(localStorage.getItem(peopleKey))||[];
        data=s.data||data; history=s.history||history; redoStack=s.redoStack||JSON.parse(localStorage.getItem(redoKey))||[];
        bookings=s.bookings||bookings; columnOrder=s.columnOrder||Object.keys(prices); xp=s.xp||xp;
      }else{
        people=JSON.parse(localStorage.getItem(peopleKey))||[];
        redoStack=JSON.parse(localStorage.getItem(redoKey))||[];
      }
    }catch(e){ fallbackLoad(); }
  }else{ fallbackLoad(); }

  CORE.forEach(n=>{ if(!people.includes(n)) people.push(n); });

  saveAll(); buildTable(); updateTodayBanner(); subscribeRealtime(); updateUndoRedoButtons();
  await ensureXpFromExistingStricheAfterLoad();
  scheduleMidnightRefresh(()=>{ updateTodayBanner(); buildTable(); });
}
function fallbackLoad(){
  prices=JSON.parse(localStorage.getItem(pricesKey))||prices;
  people=JSON.parse(localStorage.getItem(peopleKey))||[];
  data=JSON.parse(localStorage.getItem(dataKey))||data;
  history=JSON.parse(localStorage.getItem(historyKey))||history;
  redoStack=JSON.parse(localStorage.getItem(redoKey))||[];
  bookings=JSON.parse(localStorage.getItem(bookingsKey))||bookings;
  columnOrder=JSON.parse(localStorage.getItem(orderKey))||Object.keys(prices);
  xp=JSON.parse(localStorage.getItem(xpKey))||xp;
}

async function ensureXpFromExistingStricheAfterLoad(){
  const drinks=Object.keys(prices); let changed=false;
  people.forEach(p=>{
    let x=0; drinks.forEach(d=>{ const cnt=data[`${p}_${d}`]||0; x += cnt*(prices[d]||0); });
    if((xp[p]||0) < x){ xp[p]=x; changed=true; }
  });
  if(changed){ saveAll(); buildTable(); }
}

/* Save + Realtime */
function saveAll(){
  localStorage.setItem(pricesKey,JSON.stringify(prices));
  localStorage.setItem(peopleKey,JSON.stringify(people));
  localStorage.setItem(dataKey,JSON.stringify(data));
  localStorage.setItem(historyKey,JSON.stringify(history));
  localStorage.setItem(redoKey,JSON.stringify(redoStack));
  localStorage.setItem(bookingsKey,JSON.stringify(bookings));
  localStorage.setItem(orderKey,JSON.stringify(columnOrder));
  localStorage.setItem(xpKey,JSON.stringify(xp));
  if(db){
    db.collection(STATE_COLLECTION).doc("global").set(
      {prices,people,data,history,redoStack,bookings,columnOrder,xp},
      {merge:true}
    ).catch(()=>{});
  }
}
function subscribeRealtime(){
  if(!db) return;
  db.collection(STATE_COLLECTION).doc("global").onSnapshot(snap=>{
    if(!snap.exists) return;
    const s=snap.data();
    prices=s.prices||prices; people=s.people||people; data=s.data||data; history=s.history||history;
    redoStack=s.redoStack||redoStack; bookings=s.bookings||bookings; columnOrder=s.columnOrder||columnOrder; xp=s.xp||xp;
    CORE.forEach(n=>{ if(!people.includes(n)) people.push(n); });
    buildTable(); updateTodayBanner(); updateUndoRedoButtons();
  });
  db.collection("hausdienst").doc(todayStr()).onSnapshot(doc=>{
    hdToday = doc && doc.exists ? doc.data().person : null;
    updateTodayBanner(hdToday); buildTable();
  });
}

/* Heute-Banner + CTA */
async function updateTodayBanner(existing){
  try{
    let person=existing;
    if(person===undefined){
      if(db){
        const d=await db.collection("hausdienst").doc(todayStr()).get();
        person = d.exists ? d.data().person : null;
      }else{ person=null; }
    }
    hdToday=person;

    const infoEl=document.getElementById("todayInfo");
    const ctaEl=document.getElementById("todayCta");

    infoEl.innerHTML = person
      ? `Heute eingetragener Hausdienst: <span class="badge ok">${person}</span>`
      : `Heute: <span class="badge none">Noch niemand eingetragen</span>`;

    ctaEl.innerHTML = `
      <button class="cta-check" onclick="openChecklist()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2l-3.5-3.5-1.4 1.4L9 19 20.3 7.7l-1.4-1.4z"/></svg>
        Checkliste √∂ffnen
      </button>
      <span class="cta-sub">Direkt zur Aufgaben√ºbersicht</span>
    `;
  }catch(e){
    document.getElementById("todayInfo").textContent="Heute: Status nicht verf√ºgbar (offline?)";
    document.getElementById("todayCta").innerHTML = `<button class="cta-check" onclick="openChecklist()">Checkliste √∂ffnen</button>`;
  }
}
function openChecklist(){ location.href = 'hausdienst.html#check'; }

/* Undo/Redo */
function updateUndoRedoButtons(){
  const u=document.getElementById("undoBtn"), r=document.getElementById("redoBtn");
  if(!u||!r) return; u.disabled = history.length===0; r.disabled = redoStack.length===0;
}
function applyAction(a){
  if(a.type==="inc"){
    data[a.id] = (a.prev||0) + 1;
    if(a.person){ xp[a.person] = (xp[a.person]||0) + (a.xpDelta||0); }
  } else if (a.action==="change"){
    data[a.id] = (a.prev||0) + 1;
    const parts=a.id.split('_'); const person=parts[0]; const drink=parts.slice(1).join('_');
    xp[person] = (xp[person]||0) + (prices[drink]||0);
  } else if (a.type==="admin_subtract") {
    data[a.id] = a.new;
    xp[a.person] = (xp[a.person]||0) + a.xpChange;
    updateTotalsFor(a.person);
  }
}
function applyInverse(a){
  if(a.type==="inc"){
    data[a.id] = a.prev;
    if(a.person){ xp[a.person] = Math.max(0,(xp[a.person]||0) - (a.xpDelta||0)); }
  } else if (a.action==="change"){
    data[a.id] = a.prev;
    const parts=a.id.split('_'); const person=parts[0]; const drink=parts.slice(1).join('_');
    xp[person] = Math.max(0,(xp[person]||0) - (prices[drink]||0));
  } else if (a.type==="admin_subtract") {
    data[a.id] = a.prev;
    xp[a.person] = Math.max(0,(xp[a.person]||0) - a.xpChange);
    updateTotalsFor(a.person);
  }
}
function undoLast(){ const last=history.pop(); if(!last) return; applyInverse(last); redoStack.push(last); saveAll(); buildTable(); updateUndoRedoButtons(); }
function redoLast(){ const act=redoStack.pop(); if(!act) return; applyAction(act); history.push(act); saveAll(); buildTable(); updateUndoRedoButtons(); }

/* Delete mode inkl. Personen l√∂schen */
function toggleDeleteMode(){
  deleteMode=!deleteMode;
  const btn=document.getElementById("deleteBtn");
  btn.textContent= deleteMode ? "‚úñ Abbrechen" : "üóë L√∂schen";
  btn.classList.toggle("ghost", deleteMode);
  document.body.classList.toggle('delete-mode', deleteMode);
  const hint=document.getElementById('delInfo');
  if(hint) hint.style.display = deleteMode ? 'block' : 'none';
  buildTable();
}
function personCellClick(p){
  if(!deleteMode) return;
  deletePerson(p);
}

/* Tabelle + Level-Ring */
function buildTable(){
  const core=CORE.filter(n=>people.includes(n));
  const guests=people.filter(n=>!CORE.includes(n)).sort((a,b)=>a.localeCompare(b));

  let html = `<table><thead><tr><th style="min-width:240px;text-align:left">Person</th>`;
  columnOrder.forEach(drink=>{
    if(prices[drink]!==undefined){
      const delTitle = deleteMode ? ` title="Zum L√∂schen tippen"` : '';
      html += `<th onclick="headerClick('${drink}')"${delTitle}>
        <span class="drink-chip"><span class="drink-name">${drink.replace('_',' ')}</span>
        <span class="drink-price">${prices[drink]} ‚Ç¨</span></span>
      </th>`;
    }
  });
  html += `<th>Gesamt (‚Ç¨)</th></tr></thead><tbody>`;

  const ring=(xpVal, person)=>{
    const x=+xpVal||0;
    const lvl=Math.max(1, Math.floor(Math.sqrt(x/75))+1);
    const min=75*(lvl-1)*(lvl-1), max=75*lvl*lvl;
    const p=Math.max(0,Math.min(1,(x-min)/(max-min)));
    const r=22, c=2*Math.PI*r, off=(1-p)*c, gid="grad_"+person.replace(/[^a-z0-9]/gi,'')+"_"+lvl;
    return `<div class="lvl-ring" role="img" aria-label="Level ${lvl}, ${Math.round(p*100)}%">
      <svg viewBox="0 0 52 52" width="100%" height="100%" style="transform:rotate(-90deg)">
        <defs><linearGradient id="${gid}" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="var(--accent,#6ee7ff)"/><stop offset="100%" stop-color="var(--accent-2,#a78bfa)"/></linearGradient></defs>
        <circle cx="26" cy="26" r="${r}" stroke="#2a2f3b" stroke-width="6" fill="none"/>
        <circle cx="26" cy="26" r="${r}" stroke="url(#${gid})" stroke-width="6" stroke-linecap="round" fill="none"
                stroke-dasharray="${c}" stroke-dashoffset="${off}"/></svg>
      <div class="val">Lv. ${lvl}</div></div>`;
  };

  const row=(p)=>{
    const xpVal=getXpForDisplay(p);
    const hdClass=(hdToday===p)?"hd-today":"";
    const personTitle = deleteMode ? ` title="Person l√∂schen"` : '';
    let rhtml = `<tr class="${hdClass}"><th style="text-align:left">
      <div class="person-cell"${personTitle} onclick="personCellClick('${p}')">
        ${ring(xpVal,p)}<div class="p-info"><div class="p-name">${p}</div></div>
      </div></th>`;
    columnOrder.forEach(dr=>{
      if(prices[dr]!==undefined){
        const id=`${p}_${dr}`, val=data[id]||0, handler=`()=>inc('${id}','${dr}','${p}')`;
        rhtml += `<td><div class="cell" onclick="inc('${id}','${dr}','${p}')">
          <div class="count" id="${id}">${val}</div>
          <button class="btn small plus-btn" onclick="event.stopPropagation(); inc('${id}','${dr}','${p}')"
            onmousedown="startHold(${handler})" onmouseup="stopHold()" onmouseleave="stopHold()"
            ontouchstart="startHold(${handler})" ontouchend="stopHold()">+1</button></div></td>`;
      }
    });
    const total=columnOrder.reduce((s,d)=>s+(data[`${p}_${d}`]||0)*prices[d],0);
    rhtml += `<td id="${p}_Total">${total.toFixed(2)}</td></tr>`;
    return rhtml;
  };

  /* Kernteam */
  if(core.length){
    html += `<tr class="section-row"><td colspan="${columnOrder.length+2}">‚Äî Kernteam ‚Äî</td></tr>`;
    core.forEach(p=> html += row(p));
  }

  /* G√§ste immer anzeigen */
  if(guests.length){
    html += `<tr class="section-row"><td colspan="${columnOrder.length+2}">‚Äî G√§ste ‚Äî</td></tr>`;
    guests.forEach(p=> html += row(p));
  }

  html += `</tbody></table>`;
  document.getElementById("tableContainer").innerHTML = html;
  requestAnimationFrame(adjustToOnePage);
}

/* Onepage fit (f√ºr Kernteam-Spaltenh√∂hen) */
function adjustToOnePage(){
  const appbar=document.querySelector('.appbar')?.offsetHeight||0;
  document.documentElement.style.setProperty('--sticky-top', Math.max(40, appbar)+4+'px');
  const bottom=document.querySelector('.bottomnav')?.offsetHeight||0;
  const cards=Array.from(document.querySelectorAll('.content .card')).filter((el,i)=> i!==1 );
  const other=appbar+bottom+cards.reduce((s,c)=>s+c.offsetHeight,0)+20;
  const avail=window.innerHeight - other;
  const headH=36, coreCount=10, rowsTotal=coreCount;

  let rowH=Math.max(42, Math.min(72, Math.floor((avail - headH)/rowsTotal)));
  let ring=Math.max(36, Math.min(56, rowH-10));
  let name=Math.max(18, Math.min(22, Math.floor(rowH*0.45)));
  let count=Math.max(16, Math.min(20, Math.floor(rowH*0.40)));
  let pad=Math.max(4, Math.floor((rowH-34)/2));

  document.documentElement.style.setProperty('--row-pad', pad+'px');
  document.documentElement.style.setProperty('--ring', ring+'px');
  document.documentElement.style.setProperty('--name-size', name+'px');
  document.documentElement.style.setProperty('--count-size', count+'px');
  document.documentElement.style.setProperty('--cell-gap', Math.max(8, Math.floor(rowH*0.22))+'px');
}

/* Interactions */
function headerClick(drink){ if(deleteMode) deleteColumn(drink); }
function inc(id,drink,person){
  const el=document.getElementById(id); const cur=parseInt(el?.textContent||'0'), next=cur+1;
  if(el){ el.textContent=next; el.classList.remove('bump'); void el.offsetWidth; el.classList.add('bump'); }
  const xpDelta=prices[drink]||0;
  history.push({type:"inc", id, prev:cur, person, xpDelta}); redoStack=[];
  data[id]=next;
  const before=levelOf((xp[person]||0)); xp[person]=(xp[person]||0)+xpDelta; const after=levelOf(xp[person]);
  (after>before ? sLevel : sClick).play();
  updateTotalsFor(person); saveAll(); updateUndoRedoButtons();
}
function updateTotalsFor(person){
  const tot=columnOrder.reduce((s,d)=>s+(data[`${person}_${d}`]||0)*prices[d],0);
  const el=document.getElementById(`${person}_Total`); if(el) el.textContent=tot.toFixed(2);
  buildTable();
}

/* Delete helpers */
function deletePerson(p){
  if(!deleteMode) return;
  if(CORE.includes(p)){ alert("Kernteam kann nicht gel√∂scht werden."); toggleDeleteMode(); return; }
  if(!confirm(`${p} wirklich l√∂schen?`)) return;
  people=people.filter(x=>x!==p);
  Object.keys(data).forEach(k=>{ if(k.startsWith(p+"_")) delete data[k]; });
  delete xp[p];
  saveAll(); buildTable(); toggleDeleteMode();
}
function deleteColumn(drink){
  if(!deleteMode) return;
  if(!confirm(`Getr√§nk "${drink}" l√∂schen?`)) return;
  delete prices[drink]; columnOrder=columnOrder.filter(d=>d!==drink);
  Object.keys(data).forEach(k=>{ if(k.endsWith("_"+drink)) delete data[k]; });
  saveAll(); buildTable(); toggleDeleteMode();
}

/* Abrechnen */
function resetAll(){
  const pw=prompt("Passwort eingeben:"); if(pw!=="1379"){alert("Falsches Passwort");return;}
  if(!confirm("Alle Striche abrechnen und zur√ºcksetzen?")) return;
  people.forEach(p=>{
    const sum=columnOrder.reduce((s,d)=>s+(data[`${p}_${d}`]||0)*prices[d],0);
    if(sum>0) bookings.push({date:new Date().toLocaleDateString("de-DE"), person:p, sum});
    xp[p]=(xp[p]||0)+sum; columnOrder.forEach(d=>data[`${p}_${d}`]=0);
  });
  history=[]; redoStack=[]; saveAll(); buildTable(); updateUndoRedoButtons();
}

/* Modals & helpers */
function openPersonModal(){ document.getElementById("personModal").classList.add("show"); }
function openDrinkModal(){ document.getElementById("drinkModal").classList.add("show"); }
function closeModal(id){ document.getElementById(id).classList.remove("show"); }
function togglePayPal(){ document.getElementById("paypalModal").classList.toggle("show"); }
function confirmAddPerson(){
  const name=document.getElementById("personName").value.trim(); if(!name) return alert("Bitte Namen eingeben");
  if(people.includes(name)) return alert("Person existiert bereits");
  people.push(name); saveAll(); buildTable(); closeModal('personModal'); document.getElementById("personName").value="";
}
function confirmAddDrink(){
  const name=document.getElementById("drinkName").value.trim(), price=parseFloat(document.getElementById("drinkPrice").value);
  if(!name||isNaN(price)||price<=0) return alert("Bitte g√ºltige Eingaben");
  const key=name.replace(/\s+/g,'_'); prices[key]=price; if(!columnOrder.includes(key)) columnOrder.push(key);
  saveAll(); buildTable(); closeModal('drinkModal'); document.getElementById("drinkName").value=""; document.getElementById("drinkPrice").value="";
}

/* SW */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js?v=21', { scope: './' }).catch(()=>{});
}

window.onload=loadState;
window.onresize=()=>requestAnimationFrame(adjustToOnePage);
</script>
</body>
</html>